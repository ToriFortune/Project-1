define(["require","jquery","lodash","store","url","core/ajax","components/alert-dismissable","components/visited-artists"],function(t){"use strict";function s(){var t=i(document).find("[data-page-resource-type]"),s=t.attr("data-page-resource-type"),a=t.attr("data-page-resource-blacklist-level");if(e(s)&&-1===["1","3"].indexOf(a))return t.attr("data-page-resource-artist-name")||t.attr("data-page-resource-name")}function e(t){return"artist"==t||"track"==t||"album"==t}var i=t("jquery"),a=(t("lodash"),t("store"),t("url")),r=t("core/ajax"),n=t("components/alert-dismissable"),o=t("components/visited-artists"),h=function(t,s){this.$el=t,this.app=s,this.lastArtist=null,this.lastLang=s.lang(),this.pageTransitionSubscription=null,this.alertDismissable=new n(this.$el,this.app)};return h.prototype.start=function(){this.url=this.$el.data("url"),this.visitedArtists=new o,this.$el.on("click.lazyrecs",".js-lazy-recs-bar-show-more",this.expandRecommendationsPanel.bind(this)),this.$el.on("click.lazyrecs",".js-lazy-recs-bar-close",this.closeRecsBar.bind(this)),this.pageTransitionSubscription=this.app.eventMediator.subscribe("page.transitionComplete",this.updateRecommendationsForPage.bind(this)),this.updateRecommendationsForPage()},h.prototype.stop=function(){this.$el.off(".lazyrecs"),this.app.eventMediator.unsubscribe(this.pageTransitionSubscription)},h.prototype.expandRecommendationsPanel=function(t){t.preventDefault(),this.$el.addClass("lazy-recs-bar--extended"),i("body").addClass("has-lazy-recs-bar--extended")},h.prototype.updateRecommendationsForPage=function(){var t=s();if(t&&this.recordArtistVisit(t),this.isDisabled())return void this.hideBar();this.isStale()?this.refreshRecommendations():this.hasContent?this.showBar():this.hideBar()},h.prototype.isDisabled=function(){return!this.app.adsEnabled()||i("body").hasClass("js-disable-lazy-recs-bar")},h.prototype.recordArtistVisit=function(t){this.visitedArtists.recordVisit(t)},h.prototype.isStale=function(){var t=this.visitedArtists.toArray();return t.length&&(t[0]!=this.lastArtist||this.lastLang!==this.app.lang())},h.prototype.refreshRecommendations=function(){var t=this.visitedArtists.toArray();t.length&&this.url&&(this.lastArtist=t[0],this.lastLang=this.app.lang(),r.get(a(this.url,this.lastLang),null,{artists:t},this.renderResponse.bind(this)))},h.prototype.renderResponse=function(t,s){!t&&s&&(this.hasContent=!0,this.$el.html(s),this.showBar())},h.prototype.closeRecsBar=function(t){this.alertDismissable.close(t,this.hideBar.bind(this)),this.stop()},h.prototype.showBar=function(){this.$el.removeClass("lazy-recs-bar--hidden"),i("body").addClass("has-lazy-recs-bar"),this.publishedShown||(this.app.eventMediator.publish("lazy-recs-bar.shown"),this.publishedShown=!0)},h.prototype.hideBar=function(){this.$el.addClass("lazy-recs-bar--hidden"),i("body").removeClass("has-lazy-recs-bar")},h});